title = "–í–∏–¥–∞—á–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"
url = "/manager/order/:orderId"
layout = ""
is_hidden = 0
==
<?php
function onStart() {
    $this['orderId'] = $this->param('orderId');
}
?>
==
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–∞—á–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è - FarforRent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-white border-b sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center gap-4">
                    <button onclick="window.location.href='/manager-new'" class="p-2 hover:bg-gray-100 rounded">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="flex-1 flex items-center gap-3">
                        <span class="badge bg-green-100 text-green-700 border border-green-200 px-3 py-1 rounded-full text-sm font-semibold">–í–∏–¥–∞—á–∞</span>
                        <span class="text-xl font-bold">‚Ññ<span id="order-number">...</span></span>
                        <span class="text-gray-500" id="time-slot">‚Ä¢ ...</span>
                    </div>
                    <button onclick="printPickList()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        <i class="fas fa-print mr-2"></i>–î—Ä—É–∫ –ø—ñ–∫-–ª—ñ—Å—Ç–∞
                    </button>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Client & Dates -->
                    <div class="bg-white rounded-lg border p-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <div class="text-sm text-gray-500 mb-1">–ö–ª—ñ—î–Ω—Ç</div>
                                <div class="font-semibold text-lg" id="client-name">...</div>
                                <div class="text-sm text-blue-600 mt-1" id="client-phone">...</div>
                                <div class="text-sm text-gray-600" id="client-email">...</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 mb-1">–î–∞—Ç–∏ –æ—Ä–µ–Ω–¥–∏</div>
                                <div class="flex items-center gap-2">
                                    <div>
                                        <div class="text-xs text-gray-500">–í–∏–¥–∞—á–∞</div>
                                        <div class="font-semibold" id="issue-date">...</div>
                                    </div>
                                    <div class="text-gray-400">‚Üí</div>
                                    <div>
                                        <div class="text-xs text-gray-500">–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</div>
                                        <div class="font-semibold" id="return-date">...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 space-y-3">
                            <div class="bg-blue-50 p-3 rounded-lg" id="client-comment-block" style="display:none;">
                                <div class="text-xs text-gray-500 mb-1">–ö–æ–º–µ–Ω—Ç–∞—Ä –∫–ª—ñ—î–Ω—Ç–∞:</div>
                                <div class="text-sm" id="client-comment"></div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">–ö–æ–º–µ–Ω—Ç–∞—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞:</label>
                                <textarea id="manager-comment" class="w-full border rounded-lg p-2 min-h-[60px]" placeholder="–î–æ–¥–∞–π—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Scanning Panel -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <div class="flex items-center gap-3">
                            <input 
                                type="text" 
                                id="scan-input" 
                                placeholder="–°–∫–∞–Ω—É–≤–∞—Ç–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ / QR"
                                class="flex-1 text-lg border rounded-lg px-4 py-2"
                                onkeypress="if(event.key==='Enter') handleScan()"
                            >
                            <button onclick="handleScan()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-qrcode mr-2"></i>–°–∫–∞–Ω—É–≤–∞—Ç–∏
                            </button>
                        </div>
                        <div class="mt-3 text-sm text-gray-600">
                            –ü—Ä–æ–≥—Ä–µ—Å –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü—ñ—ó: <span class="font-bold" id="picking-progress">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Items List -->
                    <div class="bg-white rounded-lg border">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold">–ü–æ–∑–∏—Ü—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
                        </div>
                        <div id="items-container" class="p-6">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="space-y-6">
                    <!-- Financial Summary -->
                    <div class="bg-white rounded-lg border">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold">–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –ø—ñ–¥—Å—É–º–æ–∫</h3>
                        </div>
                        <div class="p-6 space-y-3">
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">–û—Ä–µ–Ω–¥–∞</span>
                                <span class="font-semibold" id="fin-rental">‚Ç¥0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">–ó–∞—Å—Ç–∞–≤–∞</span>
                                <span class="font-semibold" id="fin-deposit">‚Ç¥0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                                <span class="font-semibold" id="fin-delivery">‚Ç¥0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b text-green-600" id="discount-row" style="display:none;">
                                <span>–ó–Ω–∏–∂–∫–∞</span>
                                <span class="font-semibold" id="fin-discount">-‚Ç¥0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">–ü–µ—Ä–µ–¥–ø–ª–∞—Ç–∞</span>
                                <span class="font-semibold text-green-600" id="fin-prepaid">‚Ç¥0</span>
                            </div>
                            <div class="flex justify-between py-3 text-lg border-t-2">
                                <span class="font-bold">–î–æ —Å–ø–ª–∞—Ç–∏</span>
                                <span class="font-bold text-blue-600" id="fin-total">‚Ç¥0</span>
                            </div>

                            <div class="pt-4 space-y-3">
                                <button onclick="sendInvoice()" class="w-full border rounded-lg py-2 hover:bg-gray-50">
                                    <i class="fas fa-file-invoice mr-2"></i>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫
                                </button>
                                <button onclick="saveChanges()" class="w-full border rounded-lg py-2 hover:bg-gray-50">
                                    <i class="fas fa-save mr-2"></i>–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
                                </button>
                                <button onclick="issueOrder()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-lg hover:from-green-600 hover:to-green-700 font-semibold">
                                    <i class="fas fa-check-circle mr-2"></i>–í–∏–¥–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const orderId = {{ orderId }};
        let orderData = null;
        let items = [];

        async function loadOrder() {
            try {
                const response = await fetch(`/api/manager/orders/${orderId}`);
                orderData = await response.json();
                
                // Update UI
                document.getElementById('order-number').textContent = orderData.id || orderId;
                document.getElementById('client-name').textContent = orderData.customer_name || '–ö–ª—ñ—î–Ω—Ç';
                document.getElementById('client-phone').textContent = orderData.customer_phone || '';
                document.getElementById('client-email').textContent = orderData.customer_email || '';
                document.getElementById('issue-date').textContent = orderData.date_from || '';
                document.getElementById('return-date').textContent = orderData.date_to || '';
                
                if (orderData.note) {
                    document.getElementById('client-comment-block').style.display = 'block';
                    document.getElementById('client-comment').textContent = orderData.note;
                }
                
                // Financial
                document.getElementById('fin-rental').textContent = '‚Ç¥' + (orderData.rent_total || 0);
                document.getElementById('fin-deposit').textContent = '‚Ç¥' + (orderData.deposit_total || 0);
                document.getElementById('fin-total').textContent = '‚Ç¥' + (orderData.rent_total || 0);
                
                items = orderData.items || [];
                renderItems();
                updateProgress();
            } catch (error) {
                console.error('Error:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
            }
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            if (items.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</div>';
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="border rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                    <div class="flex gap-4">
                        <div class="w-20 h-20 bg-gray-100 rounded border flex items-center justify-center">
                            <i class="fas fa-image text-gray-400 text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-semibold">${item.name}</div>
                                    <div class="text-sm text-gray-500">${item.sku || ''}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-lg">‚Ç¥${item.subtotal || 0}</div>
                                    <div class="text-xs text-gray-500">‚Ç¥${item.rent_price || 0}/–¥–æ–±–∞</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-4 gap-4 mt-3">
                                <div>
                                    <div class="text-xs text-gray-500">–ó–∞–º–æ–≤–ª–µ–Ω–æ</div>
                                    <div class="font-semibold">${item.qty}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">–ü—ñ–¥—ñ–±—Ä–∞–Ω–æ</div>
                                    <div class="font-semibold flex items-center gap-1">
                                        <span id="picked-${item.id}">${item.picked || 0}</span>
                                        ${(item.picked || 0) >= item.qty ? 
                                            '<i class="fas fa-check-circle text-green-600"></i>' : 
                                            '<i class="fas fa-times-circle text-orange-600"></i>'}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">–ù–∞—è–≤–Ω—ñ—Å—Ç—å</div>
                                    <div class="font-semibold text-green-600">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">–ó–∞—Å—Ç–∞–≤–∞</div>
                                    <div class="font-semibold">‚Ç¥${item.deposit_per_item || 0}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function handleScan() {
            const barcode = document.getElementById('scan-input').value.trim();
            if (!barcode) return;
            
            const item = items.find(i => i.sku === barcode);
            if (item && (item.picked || 0) < item.qty) {
                item.picked = (item.picked || 0) + 1;
                renderItems();
                updateProgress();
                alert(`‚úÖ –í—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: ${item.name} (+1)`);
            } else {
                alert('‚ö†Ô∏è –®—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∂–µ –∑—ñ–±—Ä–∞–Ω–∞');
            }
            
            document.getElementById('scan-input').value = '';
            document.getElementById('scan-input').focus();
        }

        function updateProgress() {
            const totalQty = items.reduce((sum, i) => sum + i.qty, 0);
            const pickedQty = items.reduce((sum, i) => sum + (i.picked || 0), 0);
            const progress = totalQty > 0 ? Math.round((pickedQty / totalQty) * 100) : 0;
            
            document.getElementById('picking-progress').textContent = progress + '%';
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function issueOrder() {
            const allPicked = items.every(item => (item.picked || 0) >= item.qty);
            if (!allPicked && !confirm('–ù–µ –≤—Å—ñ –ø–æ–∑–∏—Ü—ñ—ó –∑—ñ–±—Ä–∞–Ω–æ. –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å —á–∞—Å—Ç–∫–æ–≤—É –≤–∏–¥–∞—á—É?')) {
                return;
            }
            
            alert('‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∞–Ω–æ –∫–ª—ñ—î–Ω—Ç—É!');
            setTimeout(() => window.location.href = '/manager-new', 1000);
        }

        function saveChanges() {
            alert('‚úÖ –ó–º—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        }

        function sendInvoice() {
            alert('üìß –†–∞—Ö—É–Ω–æ–∫ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –Ω–∞ email –∫–ª—ñ—î–Ω—Ç–∞');
        }

        function printPickList() {
            window.print();
        }

        loadOrder();
    </script>
</body>
</html>