title = "Повернення замовлення"
url = "/manager/return/:orderId"
layout = ""
is_hidden = 0
==
<?php
function onStart() {
    $this['orderId'] = $this->param('orderId');
}
?>
==
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Повернення замовлення - FarforRent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-white border-b sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center gap-4">
                    <button onclick="window.location.href='/manager-new'" class="p-2 hover:bg-gray-100 rounded">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="flex-1 flex items-center gap-3">
                        <span class="badge bg-blue-100 text-blue-700 border border-blue-200 px-3 py-1 rounded-full text-sm font-semibold">Повернення</span>
                        <span class="text-xl font-bold">№<span id="order-number">...</span></span>
                    </div>
                    <button onclick="window.print()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        <i class="fas fa-print mr-2"></i>Друк акту
                    </button>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Scanning Panel -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="font-semibold mb-4">Сканування повернення</h3>
                        <div class="flex items-center gap-3">
                            <input 
                                type="text" 
                                id="scan-input" 
                                placeholder="Відскануйте товар для повернення"
                                class="flex-1 text-lg border rounded-lg px-4 py-2"
                                onkeypress="if(event.key==='Enter') handleReturn()"
                            >
                            <button onclick="handleReturn()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-qrcode mr-2"></i>Повернути
                            </button>
                        </div>
                        <div class="mt-3 text-sm text-gray-600">
                            Повернуто: <span class="font-bold" id="return-progress">0/0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div id="progress-bar" class="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Items List -->
                    <div class="bg-white rounded-lg border">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold">Позиції для повернення</h3>
                        </div>
                        <div id="items-container" class="p-6">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Завантаження...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Damages Section -->
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-6">
                        <h3 class="font-semibold mb-4 text-orange-800">Пошкодження та втрати</h3>
                        <div id="damages-list" class="space-y-3">
                            <div class="text-sm text-gray-600">Пошкоджень не виявлено</div>
                        </div>
                        <button onclick="addDamage()" class="mt-4 w-full border border-orange-300 rounded-lg py-2 text-orange-700 hover:bg-orange-100">
                            <i class="fas fa-plus mr-2"></i>Додати пошкодження
                        </button>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="space-y-6">
                    <!-- Return Summary -->
                    <div class="bg-white rounded-lg border">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold">Підсумок повернення</h3>
                        </div>
                        <div class="p-6 space-y-3">
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Застава утримано</span>
                                <span class="font-semibold" id="deposit-held">₴0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Штрафи</span>
                                <span class="font-semibold text-red-600" id="penalties">₴0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Пошкодження</span>
                                <span class="font-semibold text-orange-600" id="damage-cost">₴0</span>
                            </div>
                            <div class="flex justify-between py-3 text-lg border-t-2">
                                <span class="font-bold">До повернення</span>
                                <span class="font-bold text-green-600" id="refund-amount">₴0</span>
                            </div>

                            <div class="pt-4">
                                <label class="text-sm text-gray-600 mb-2 block">Стан товарів:</label>
                                <select id="condition" class="w-full border rounded-lg p-2 mb-3">
                                    <option value="excellent">Відмінний</option>
                                    <option value="good">Хороший</option>
                                    <option value="fair">Задовільний</option>
                                    <option value="poor">Поганий</option>
                                </select>
                                
                                <label class="text-sm text-gray-600 mb-2 block">Коментар:</label>
                                <textarea id="return-comment" class="w-full border rounded-lg p-2 min-h-[80px]" placeholder="Додайте коментар про стан товарів..."></textarea>
                            </div>

                            <div class="pt-4 space-y-3">
                                <button onclick="processReturn()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 font-semibold">
                                    <i class="fas fa-check-circle mr-2"></i>Прийняти повернення
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Client Info -->
                    <div class="bg-white rounded-lg border p-6">
                        <h3 class="font-semibold mb-3">Інформація про клієнта</h3>
                        <div class="space-y-2 text-sm">
                            <div>
                                <span class="text-gray-500">Ім'я:</span>
                                <div class="font-semibold" id="client-name">...</div>
                            </div>
                            <div>
                                <span class="text-gray-500">Телефон:</span>
                                <div class="font-semibold" id="client-phone">...</div>
                            </div>
                            <div>
                                <span class="text-gray-500">Дата видачі:</span>
                                <div class="font-semibold" id="issue-date">...</div>
                            </div>
                            <div>
                                <span class="text-gray-500">Очікуване повернення:</span>
                                <div class="font-semibold" id="expected-return">...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const orderId = {{ orderId }};
        let orderData = null;
        let items = [];
        let damages = [];

        async function loadOrder() {
            try {
                const response = await fetch(`/api/manager/orders/${orderId}`);
                orderData = await response.json();
                
                document.getElementById('order-number').textContent = orderData.id || orderId;
                document.getElementById('client-name').textContent = orderData.customer_name || 'Клієнт';
                document.getElementById('client-phone').textContent = orderData.customer_phone || '';
                document.getElementById('issue-date').textContent = orderData.date_from || '';
                document.getElementById('expected-return').textContent = orderData.date_to || '';
                document.getElementById('deposit-held').textContent = '₴' + (orderData.deposit_total || 0);
                document.getElementById('refund-amount').textContent = '₴' + (orderData.deposit_total || 0);
                
                items = (orderData.items || []).map(item => ({
                    ...item,
                    returned: 0
                }));
                
                renderItems();
                updateProgress();
            } catch (error) {
                console.error('Error:', error);
                alert('Помилка завантаження замовлення');
            }
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            if (items.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Немає товарів</div>';
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="border rounded-lg p-4 mb-4">
                    <div class="flex gap-4">
                        <div class="w-16 h-16 bg-gray-100 rounded border flex items-center justify-center">
                            <i class="fas fa-box text-gray-400 text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold">${item.name}</div>
                            <div class="text-sm text-gray-500">${item.sku || ''}</div>
                            <div class="mt-2 flex items-center gap-4">
                                <div>
                                    <span class="text-xs text-gray-500">Видано:</span>
                                    <span class="font-semibold ml-1">${item.qty}</span>
                                </div>
                                <div>
                                    <span class="text-xs text-gray-500">Повернуто:</span>
                                    <span class="font-semibold ml-1 ${item.returned >= item.qty ? 'text-green-600' : 'text-orange-600'}" id="returned-${item.id}">${item.returned}</span>
                                    ${item.returned >= item.qty ? '<i class="fas fa-check-circle text-green-600 ml-1"></i>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500">Застава</div>
                            <div class="font-semibold">₴${item.deposit_per_item || 0}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function handleReturn() {
            const barcode = document.getElementById('scan-input').value.trim();
            if (!barcode) return;
            
            const item = items.find(i => i.sku === barcode);
            if (item && item.returned < item.qty) {
                item.returned++;
                renderItems();
                updateProgress();
                alert(`✅ Повернуто: ${item.name} (+1)`);
            } else {
                alert('⚠️ Товар не знайдено або вже повернуто повністю');
            }
            
            document.getElementById('scan-input').value = '';
            document.getElementById('scan-input').focus();
        }

        function updateProgress() {
            const totalQty = items.reduce((sum, i) => sum + i.qty, 0);
            const returnedQty = items.reduce((sum, i) => sum + i.returned, 0);
            const progress = totalQty > 0 ? Math.round((returnedQty / totalQty) * 100) : 0;
            
            document.getElementById('return-progress').textContent = `${returnedQty}/${totalQty}`;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function addDamage() {
            const itemName = prompt('Назва пошкодженого товару:');
            if (!itemName) return;
            
            const cost = prompt('Вартість відшкодування (₴):');
            if (!cost) return;
            
            damages.push({ item: itemName, cost: parseFloat(cost) });
            renderDamages();
            updateFinancials();
        }

        function renderDamages() {
            const container = document.getElementById('damages-list');
            if (damages.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-600">Пошкоджень не виявлено</div>';
                return;
            }
            
            container.innerHTML = damages.map((d, i) => `
                <div class="bg-white border border-orange-300 rounded p-3 flex justify-between items-center">
                    <div>
                        <div class="font-semibold text-sm">${d.item}</div>
                        <div class="text-xs text-gray-500">Відшкодування: ₴${d.cost}</div>
                    </div>
                    <button onclick="removeDamage(${i})" class="text-red-600 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeDamage(index) {
            damages.splice(index, 1);
            renderDamages();
            updateFinancials();
        }

        function updateFinancials() {
            const totalDamages = damages.reduce((sum, d) => sum + d.cost, 0);
            document.getElementById('damage-cost').textContent = '₴' + totalDamages;
            
            const deposit = parseFloat(document.getElementById('deposit-held').textContent.replace('₴', ''));
            const refund = deposit - totalDamages;
            document.getElementById('refund-amount').textContent = '₴' + Math.max(0, refund);
        }

        function processReturn() {
            const allReturned = items.every(item => item.returned >= item.qty);
            if (!allReturned && !confirm('Не всі товари повернуто. Продовжити?')) {
                return;
            }
            
            alert('✅ Повернення оброблено успішно!');
            setTimeout(() => window.location.href = '/manager-new', 1000);
        }

        loadOrder();
    </script>
</body>
</html>